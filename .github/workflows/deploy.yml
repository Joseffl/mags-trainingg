name: VPS Deployment

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # 1. Enter the directory
            cd /home/magsengineeringlimited/htdocs/www.magsengineeringlimited.com

            git config --global --add safe.directory /home/magsengineeringlimited/htdocs/www.magsengineeringlimited.com

            
            # 2. Force reset and pull (prevents merge conflicts with manual changes)
            git fetch --all
            git reset --hard origin/main

            
            
            # 3. Create .env file from GitHub Secrets
            echo "REACT_APP_EMAILJS_SERVICE_ID=${{ secrets.REACT_APP_EMAILJS_SERVICE_ID }}" > .env
            echo "REACT_APP_EMAILJS_TEMPLATE_ID=${{ secrets.REACT_APP_EMAILJS_TEMPLATE_ID }}" >> .env
            echo "REACT_APP_EMAILJS_PUBLIC_KEY=${{ secrets.REACT_APP_EMAILJS_PUBLIC_KEY }}" >> .env
            echo "REACT_APP_FLW_PUBLIC_KEY=${{ secrets.REACT_APP_FLW_PUBLIC_KEY }}" >> .env
            echo "CI=false" >> .env
            
            # 4. Clean old build and install dependencies
            # We remove node_modules and build to ensure a 100% fresh state
            rm -rf build
            npm install
            npm run build
            
            # 5. FIX PERMISSIONS (The most important part for CloudPanel)
            # This ensures the 'magsengineeringlimited' user owns the files, not root
            sudo chown -R magsengineeringlimited:magsengineeringlimited .
            sudo chmod -R 755 build
            
            # 6. Clear Nginx cache (Optional but recommended)
            sudo systemctl reload nginx